{{ 'customer.css' | asset_url | stylesheet_tag }}

<style>
  .quote-page-container {
    padding: 30px 0;
  }
  .quote-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    font-size: 1.6rem;
  }
  .quote-table th, .quote-table td {
    border: 1px solid rgba(0,0,0,0.1);
    padding: 12px;
    text-align: left;
  }
  .quote-table th {
    background-color: #f5f5f5;
  }
  .quote-item-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
  }
  .quote-item-remove {
    color: red;
    cursor: pointer;
    text-decoration: underline;
  }
  .quote-form-container {
    max-width: 600px;
  }
  .quote-grid-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 3rem;
    align-items: start;
  }
  @media (min-width: 990px) {
    .quote-grid-layout {
      grid-template-columns: 2fr 1fr;
      width: 100%;
    }
  }
  .quote-grid-layout > div {
    background-color: #FFFFFF;
    padding: 2.5rem;
    border-radius: var(--card-corner-radius, 8px);
  }
  .visually-hidden {
    position: absolute !important;
    height: 1px;
    width: 1px;
    overflow: hidden;
    clip: rect(1px, 1px, 1px, 1px);
  }
</style>

<div class="customer page-width">
  <div class="quote-page-container">
    <h1>{{ page.title }}</h1>
    <div class="quote-grid-layout">
      <div id="quote-items-container">
        <table class="quote-table">
          <thead>
            <tr>
              <th colspan="2">Producto</th>
              <th>Cantidad</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="quote-table-body">
            <!-- Items will be injected here by JavaScript -->
          </tbody>
        </table>
      </div>

      <div class="quote-form-container">
        <h2>Completa tus datos para enviar la cotización</h2>
        <div class="form-vertical">
          {%- form 'contact', id: 'QuoteForm' -%}
            {%- if form.posted_successfully? -%}
              <p class="form-success">
                {{ 'contact.form.post_success' | t }}
              </p>
            {%- endif -%}

            {{ form.errors | default_errors }}

            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <label for="ContactForm-name">Nombre</label>
                <input type="text" id="ContactForm-name" name="contact[Nombre]" value="{% if form.name %}{{ form.name }}{% elsif customer %}{{ customer.first_name }}{% endif %}" required>
              </div>
              <div style="flex: 1; min-width: 200px;">
                <label for="ContactForm-lastname">Apellido</label>
                <input type="text" id="ContactForm-lastname" name="contact[Apellido]" value="{% if form.lastname %}{{ form.lastname }}{% elsif customer %}{{ customer.last_name }}{% endif %}" required>
              </div>
            </div>

            <label for="ContactForm-email">Correo</label>
            <input type="email" id="ContactForm-email" name="contact[Correo]" value="{% if form.email %}{{ form.email }}{% elsif customer %}{{ customer.email }}{% endif %}" required>

            <label for="ContactForm-phone">Whatsapp</label>
            <input type="tel" id="ContactForm-phone" name="contact[Whatsapp]" value="{% if form.phone %}{{ form.phone }}{% elsif customer %}{{ customer.phone }}{% endif %}" required>

            <fieldset class="form__fieldset" style="margin-top: 1.5rem; padding: 0; border: none;">
              <legend class="form__label">¿Entrega?</legend>
              <input type="radio" id="entrega-recojo" name="contact[Entrega]" value="¡Yo paso por ellos!"><label for="entrega-recojo" style="margin-left: 0.5rem; margin-right: 1.5rem; font-weight: normal;">¡Yo paso por ellos!</label>
              <input type="radio" id="entrega-local" name="contact[Entrega]" value="Entrega local en Monterrey."><label for="entrega-local" style="margin-left: 0.5rem; margin-right: 1.5rem; font-weight: normal;">Entrega local en Monterrey.</label>
              <input type="radio" id="entrega-nacional" name="contact[Entrega]" value="Envío nacional."><label for="entrega-nacional" style="margin-left: 0.5rem; font-weight: normal;">Envío nacional.</label>
            </fieldset>

            <label for="ContactForm-zip">Código postal de envío</label>
            <input type="text" id="ContactForm-zip" name="contact[Código postal de envío]">

            <fieldset class="form__fieldset" style="margin-top: 1.5rem; padding: 0; border: none;">
              <legend class="form__label">¿Con impresión?</legend>
              <input type="radio" id="impresion-si" name="contact[Impresión]" value="Con impresión"><label for="impresion-si" style="margin-left: 0.5rem; margin-right: 1.5rem; font-weight: normal;">Con impresión</label>
              <input type="radio" id="impresion-no" name="contact[Impresión]" value="Sin impresión"><label for="impresion-no" style="margin-left: 0.5rem; font-weight: normal;">Sin impresión</label>
            </fieldset>

            <label for="ContactForm-details" style="margin-top: 1.5rem;">Cuéntanos todos los detalles:</label>
            <textarea rows="7" id="ContactForm-details" name="contact[Detalles]"></textarea>

            <p style="font-size: 1.2rem; opacity: 0.8; margin-top: 1.5rem;">Si tu pedido requiere un diseño, te contactaremos por correo después de recibir tu solicitud para que nos lo envíes.</p>

            <textarea id="quote-summary-for-form" name="contact[body]" class="visually-hidden"></textarea>

            <button type="submit" id="quote-submit-button" class="button">
              Enviar Cotización
            </button>
          {%- endform -%}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const quoteTableBody = document.getElementById('quote-table-body');
    const quoteSummaryInput = document.getElementById('quote-summary-for-form');
    const submitButton = document.getElementById('quote-submit-button');

    function renderQuote() {
      if (!window.QuoteManager) {
        console.error('QuoteManager is not available.');
        quoteTableBody.innerHTML = `<tr><td colspan="4">Error: No se pudo cargar el gestor de cotizaciones.</td></tr>`;
        return;
      }

      const quoteItems = window.QuoteManager.getQuote();

      quoteTableBody.innerHTML = '';

      if (quoteItems.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `<td colspan="4">Tu cotizador está vacío. Agrega productos para poder solicitar una cotización.</td>`;
        quoteTableBody.appendChild(emptyRow);
        submitButton.disabled = true;
        quoteSummaryInput.value = 'El cotizador está vacío.';
        return;
      }

      submitButton.disabled = false;

      quoteItems.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <a href="${item.url || '#'}" title="${item.title}">
              <img src="${item.imageUrl || ''}" alt="${item.title}" class="quote-item-image">
            </a>
          </td>
          <td>
            <a href="${item.url || '#'}" style="text-decoration: none; color: inherit;">
              <strong>${item.title}</strong>
            </a><br>
            ${item.variantTitle && item.variantTitle !== 'Default Title' ? `<span>${item.variantTitle}</span><br>` : ''}
            <small>SKU: ${item.sku || 'N/A'}</small>
          </td>
          <td>
            <input type="number" class="quote-quantity-input" value="${item.quantity}" min="0" data-variant-id="${item.variantId}" style="width: 60px; padding: 5px;">
          </td>
          <td>
            <span class="quote-item-remove" data-variant-id="${item.variantId}" style="cursor: pointer; display: inline-block; width: 20px; height: 20px;">
              {{ 'icon-remove.svg' | asset_url | img_tag | replace: '<img', '<img style="width:100%;"' }}
            </span>
          </td>
        `;
        quoteTableBody.appendChild(row);
      });

      quoteSummaryInput.value = window.QuoteManager.getQuoteSummary();
      // Dispatch event for header counter to update
      document.dispatchEvent(new CustomEvent('quote:changed'));
    }

    quoteTableBody.addEventListener('click', function(event) {
      const removeButton = event.target.closest('.quote-item-remove');
      if (removeButton) {
        const variantId = removeButton.getAttribute('data-variant-id');
        window.QuoteManager.removeFromQuote(variantId);
        renderQuote();
      }
    });

    quoteTableBody.addEventListener('change', function(event) {
      if (event.target.classList.contains('quote-quantity-input')) {
        const variantId = event.target.getAttribute('data-variant-id');
        const newQuantity = event.target.value;
        window.QuoteManager.updateQuantity(variantId, newQuantity);
        // Re-render because item might be removed if quantity is 0
        renderQuote();
      }
    });

    renderQuote();
  });
</script>
